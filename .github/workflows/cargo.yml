name: Cargo

on:
  push:
    branches: [main, master]
  pull_request:

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        id: rust-toolchain
        with:
          components: rustfmt
      - name: Cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ steps.rust-toolchain.outputs.cachekey }}-${{ hashFiles('**/Cargo.lock') }}
      - name: copy ui-dev template
        run: cp crates/ui-dev/src/view.rs.template crates/ui-dev/src/view.rs
      - name: Check formatting
        run: cargo fmt --all --check

  clippy:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        id: rust-toolchain
      - &set-build-metadata
        name: Set build metadata
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
            echo "PR_HEAD_SHA=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV
          fi
      - name: Cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ steps.rust-toolchain.outputs.cachekey }}-${{ hashFiles('**/Cargo.lock') }}
      - uses: taiki-e/cache-cargo-install-action@v3
        with:
          tool: cargo-diff-tools
      - name: Fetch base ref
        run: git fetch origin ${{ github.base_ref }}
      - name: copy ui-dev template
        run: cp crates/ui-dev/src/view.rs.template crates/ui-dev/src/view.rs
      - name: Run cargo clippy
        run: cargo-clippy-diff -o GitHub origin/${{ github.base_ref }} -- -q --workspace --all-targets --all-features

  test:
    runs-on: ubuntu-latest
    env:
     TEST_ROOT_DIR: ${{ github.workspace }}
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        id: rust-toolchain
      - *set-build-metadata
      - name: Cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ steps.rust-toolchain.outputs.cachekey }}-${{ hashFiles('**/Cargo.lock') }}
      - name: Cache thirdparty libraries
        uses: actions/cache@v5
        with:
          path: |
            thirdparty/mupdf
            mupdf_wrapper/
          key: ${{ runner.os }}-thirdparty-libs-native-${{ hashFiles('thirdparty/download.sh') }}
      - uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: git wget curl pkg-config gcc g++ make cmake meson ninja-build autoconf automake libtool gperf python3 zlib1g-dev libbz2-dev libpng-dev libjpeg-dev libopenjp2-7-dev libjbig2dec0-dev libgumbo-dev libfreetype6-dev libharfbuzz-dev libdjvulibre-dev libsdl2-dev
          version: 1.0
      - name: Setup native dependencies
        run: |
          # Download mupdf sources if not cached
          if [ ! -d thirdparty/mupdf/include ]; then
            cd thirdparty
            ./download.sh mupdf
            cd ..
          fi

          # Build mupdf wrapper for Linux
          cd mupdf_wrapper
          ./build.sh
          cd ..

          # Build MuPDF for native development using system libraries
          cd thirdparty/mupdf
          [ -e .gitattributes ] && rm -rf .git*

          # Clean any previous builds
          make clean || true

          # Generate sources
          make verbose=yes generate

          # Build MuPDF libraries using system libraries
          make verbose=yes \
            mujs=no tesseract=no extract=no archive=no brotli=no barcode=no commercial=no \
            USE_SYSTEM_LIBS=yes \
            XCFLAGS="-DFZ_ENABLE_ICC=0 -DFZ_ENABLE_SPOT_RENDERING=0 -DFZ_ENABLE_ODT_OUTPUT=0 -DFZ_ENABLE_OCR_OUTPUT=0" \
            libs

          cd ../..

          # Create target directory structure
          mkdir -p target/mupdf_wrapper/Linux

          # Copy libmupdf.a
          ln -sf "$(pwd)/thirdparty/mupdf/build/release/libmupdf.a" target/mupdf_wrapper/Linux/

          # Create empty libmupdf-third.a (system libs used instead)
          if [ ! -e thirdparty/mupdf/build/release/libmupdf-third.a ]; then
            ar cr thirdparty/mupdf/build/release/libmupdf-third.a
          fi
          ln -sf "$(pwd)/thirdparty/mupdf/build/release/libmupdf-third.a" target/mupdf_wrapper/Linux/
      - name: copy ui-dev template
        run: cp crates/ui-dev/src/view.rs.template crates/ui-dev/src/view.rs
      - name: Run cargo test
        run: cargo test --workspace

  build-kobo:
    runs-on: ubuntu-latest

    permissions: &build-permissions
      id-token: write
      contents: read
      attestations: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 20
          fetch-tags: true

      - *set-build-metadata

      - uses: dtolnay/rust-toolchain@stable
        id: rust-toolchain
        with:
          targets: arm-unknown-linux-gnueabihf

      - &cache-cargo
        name: Cache Cargo registry
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ steps.rust-toolchain.outputs.cachekey }}-${{ hashFiles('**/Cargo.lock') }}

      - &cache-linaro
        name: Cache Linaro toolchain
        id: cache-linaro
        uses: actions/cache@v5
        with:
          path: ~/linaro-toolchain
          key: linaro-gcc-4.9.4-2017.01

      - &download-linaro
        name: Download Linaro toolchain
        if: steps.cache-linaro.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/linaro-toolchain
          cd ~/linaro-toolchain
          wget -q https://releases.linaro.org/components/toolchain/binaries/4.9-2017.01/arm-linux-gnueabihf/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf.tar.xz
          tar xf gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf.tar.xz --strip-components=1
          rm gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf.tar.xz

      - &cache-thirdparty
        name: Cache thirdparty libraries
        uses: actions/cache@v5
        with:
          path: |
            libs/
            thirdparty/
            mupdf_wrapper/
          key: ${{ runner.os }}-thirdparty-libs-kobo-${{ hashFiles('thirdparty/download.sh', 'thirdparty/**/build-kobo.sh', 'thirdparty/**/*.patch') }}

      - &cache-nickelmenu
        name: Cache NickelMenu downloads
        uses: actions/cache@v5
        with:
          path: .cache/
          key: ${{ runner.os }}-nickelmenu-${{ hashFiles('bundle.sh') }}

      - &install-deps
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: git wget curl pkg-config unzip jq patchelf gcc g++ make cmake meson ninja-build autoconf automake libtool gperf python3 zlib1g-dev libbz2-dev libpng-dev libjpeg-dev libopenjp2-7-dev libjbig2dec0-dev libgumbo-dev libfreetype6-dev libharfbuzz-dev libdjvulibre-dev libsdl2-dev
          version: 1.0

      - &setup-linaro
        name: Setup Linaro toolchain
        run: |
          echo "$HOME/linaro-toolchain/bin" >> $GITHUB_PATH

      - name: Build for Kobo
        env:
          CC: arm-linux-gnueabihf-gcc
          CXX: arm-linux-gnueabihf-g++
          AR: arm-linux-gnueabihf-ar
          LD: arm-linux-gnueabihf-ld
          RANLIB: arm-linux-gnueabihf-ranlib
          STRIP: arm-linux-gnueabihf-strip
          PKG_CONFIG_ALLOW_CROSS: "1"
          CARGO_TARGET_ARM_UNKNOWN_LINUX_GNUEABIHF_LINKER: arm-linux-gnueabihf-gcc
          CC_arm_unknown_linux_gnueabihf: arm-linux-gnueabihf-gcc
          AR_arm_unknown_linux_gnueabihf: arm-linux-gnueabihf-ar
        run: |
          ./build.sh slow

      - &create-dist
        name: Create distribution
        run: ./dist.sh

      - &get-commit
        name: Get commit hash
        id: commit
        run: echo "short_sha=$(echo '${{ github.event.pull_request.head.sha || github.sha }}' | cut -c1-7)" >> $GITHUB_OUTPUT

      - &determine-suffix
        name: Determine artifact suffix
        id: artifact
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "suffix=pr${{ github.event.pull_request.number }}-${{ steps.commit.outputs.short_sha }}" >> $GITHUB_OUTPUT
          else
            echo "suffix=${{ steps.commit.outputs.short_sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Build release artifacts
        run: |
          mkdir -p release-artifacts

          # Raw dist folder
          cd dist
          tar czf ../release-artifacts/cadmus-kobo.tar.gz .
          cd ..

          # KoboRoot without NickelMenu
          ./bundle.sh --no-nickel
          cp bundle/KoboRoot.tgz release-artifacts/KoboRoot.tgz

          # KoboRoot with NickelMenu
          rm -rf bundle
          ./bundle.sh
          cp bundle/KoboRoot-nm.tgz release-artifacts/KoboRoot-nm.tgz

      - &generate-attestation
        name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: |
            dist/cadmus
            dist/*.sh
            dist/scripts/*
            dist/libs/*.so*
            dist/bin/*
            release-artifacts/*.tgz

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: cadmus-kobo-${{ steps.artifact.outputs.suffix }}
          path: release-artifacts/*
          retention-days: 7

  build-kobo-test:
    runs-on: ubuntu-latest

    permissions: *build-permissions

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 20
          fetch-tags: true

      - *set-build-metadata

      - uses: dtolnay/rust-toolchain@stable
        id: rust-toolchain
        with:
          targets: arm-unknown-linux-gnueabihf
      - *cache-cargo
      - *cache-linaro
      - *download-linaro
      - *cache-thirdparty
      - *cache-nickelmenu
      - *install-deps
      - *setup-linaro

      - name: Build for Kobo (test build)
        env:
          CC: arm-linux-gnueabihf-gcc
          CXX: arm-linux-gnueabihf-g++
          AR: arm-linux-gnueabihf-ar
          LD: arm-linux-gnueabihf-ld
          RANLIB: arm-linux-gnueabihf-ranlib
          STRIP: arm-linux-gnueabihf-strip
          PKG_CONFIG_ALLOW_CROSS: "1"
          CARGO_TARGET_ARM_UNKNOWN_LINUX_GNUEABIHF_LINKER: arm-linux-gnueabihf-gcc
          CC_arm_unknown_linux_gnueabihf: arm-linux-gnueabihf-gcc
          AR_arm_unknown_linux_gnueabihf: arm-linux-gnueabihf-ar
          CARGO_FEATURES: test
        run: |
          ./build.sh slow

      - *create-dist
      - *get-commit
      - *determine-suffix

      - name: Build release artifacts
        run: |
          mkdir -p release-artifacts

          # Raw dist folder
          cd dist
          tar czf ../release-artifacts/cadmus-kobo-test.tar.gz .
          cd ..

          # KoboRoot without NickelMenu
          ./bundle.sh --no-nickel --test
          cp bundle/KoboRoot-test.tgz release-artifacts/KoboRoot-test.tgz

          # KoboRoot with NickelMenu
          rm -rf bundle
          ./bundle.sh --test
          cp bundle/KoboRoot-nm-test.tgz release-artifacts/KoboRoot-nm-test.tgz

      - *generate-attestation

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: cadmus-kobo-test-${{ steps.artifact.outputs.suffix }}
          path: release-artifacts/*
          retention-days: 7
